#!/usr/bin/env node

/**
 * Extract git history dates for deck files and update deck-history.json
 * 
 * For each deck HTML file:
 * - Gets the date of the first commit that added that file
 * - Falls back to 30 days ago if no git history exists
 * 
 * Run: node scripts/extract-git-dates.js
 */

const fs = require('fs')
const path = require('path')
const { execSync } = require('child_process')

const DECKS_DIR = path.join(__dirname, '../public/stories/decks')
const HISTORY_FILE = path.join(__dirname, '../lib/deck-history.json')

// Files to exclude (category index pages, not presentation decks)
const EXCLUDED_FILES = [
  'index.html',
  'index-old.html',
  'devex.html',
  'enterprise.html',
  'features.html',
  'learn.html',
  'showcase.html',
  'tools.html'
]

function getGitFirstCommitDate(filepath) {
  try {
    // Get the date of the first commit that added this file
    const result = execSync(
      `git log --diff-filter=A --format="%aI" -- "${filepath}" | tail -1`,
      { encoding: 'utf-8', cwd: path.dirname(filepath) }
    ).trim()
    
    if (result) {
      return result
    }
  } catch (e) {
    // Git command failed - file might not be tracked or repo issue
  }
  return null
}

function getFallbackDate() {
  // 30 days ago
  const date = new Date()
  date.setDate(date.getDate() - 30)
  return date.toISOString()
}

function main() {
  console.log('Extracting git history dates for deck files...\n')
  
  const files = fs.readdirSync(DECKS_DIR)
    .filter(f => f.endsWith('.html') && !EXCLUDED_FILES.includes(f))
    .sort()
  
  const firstSeen = {}
  const fallbackDate = getFallbackDate()
  let gitDates = 0
  let fallbackDates = 0
  
  for (const file of files) {
    const filepath = path.join(DECKS_DIR, file)
    const slug = file.replace('.html', '')
    
    const gitDate = getGitFirstCommitDate(filepath)
    
    if (gitDate) {
      firstSeen[slug] = gitDate
      gitDates++
      console.log(`  ${slug}: ${gitDate.substring(0, 10)} (git)`)
    } else {
      firstSeen[slug] = fallbackDate
      fallbackDates++
      console.log(`  ${slug}: ${fallbackDate.substring(0, 10)} (fallback - no git history)`)
    }
  }
  
  const history = {
    "_comment": "Auto-generated by scripts/extract-git-dates.js. Tracks when decks were first added based on git history.",
    "firstSeen": firstSeen
  }
  
  fs.writeFileSync(HISTORY_FILE, JSON.stringify(history, null, 2))
  
  console.log(`\nDone! Updated ${HISTORY_FILE}`)
  console.log(`  ${gitDates} decks with git history`)
  console.log(`  ${fallbackDates} decks using fallback date (30 days ago)`)
}

main()
